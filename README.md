What the load balancer should do:

• The switch should preemptively ask for the MAC addresses of all the servers with crafted ARP requests, in order to associate these MAC addresses and the corresponding switch ports with the real IP addresses of the servers. This query should be performed upon the connection establishment of the controller to the switch in order to avoid having client ﬂows waiting to be forwarded to the correct server. The ARP replies by the servers will be handled as part of the packet-in handler (see code skeleton later). 

• Answer to ARP requests from the clients searching the MAC of the service IP address. The switch should proxy ARP replies that answer to the clients’ requests with a fake MAC that is associated with the load balancer (you can use ”0A:00:00:00:00:01” for simplicity). It is useful to store the information contained in each ARP request (source MAC address of client, input port of ARP request packet). In this way, when the load balancer needs later to direct ﬂows towards the clients, it will know their MAC addresses and ports to output the packets. 

• Answer to ARP requests from the servers searching the MAC addresses of clients. The switch should proxy ARP replies that answer with the fake MAC that is associated with the load balancer. At this point you should already know the MAC of the client, since it has previously requested the MAC address of the service (see previous step).

• Redirect ﬂows from the clients towards the servers using the following load balancing mechanism: for each new IP ﬂow from a client, select a server at random and direct the ﬂow to this server. Of course, the server should see packets with their MAC address changed to the MAC of the load balancer, but with the source client IP intact. The destination IP address should also be rewritten to the one of the destination server. Be careful: the redirection should only happen for ﬂows that stem from client IPs (i.e., non-server IPs) and which are directed to the service IP. • Direct ﬂows from the servers to the clients. This should occur after rewriting the source IP address to the one of the service and the source MAC address to the load balancer fake MAC. In this way, the clients do not see any redirection happening, and they believe that all their communication takes place between their machines and the service IP (the load balancing mechanism is transparent). • There is no need to handle forwarding between the servers themselves or between the clients themselves; in this exercise we are interested in the load-balancing behaviour and the traﬃc that ﬂows between clients and servers.
